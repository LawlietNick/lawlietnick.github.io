---
import { getCollection } from "astro:content";
import Container from "@components/Container.astro";
import PageLayout from "@layouts/PageLayout.astro";
import ArrowCard from "@components/ArrowCard.astro";
import Link from "@components/Link.astro";
import { SITE, HOME, SOCIALS } from "@consts";
import ConsoleBanner from "../components/ConsoleBanner.astro";

const blog = (await getCollection("blog"))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, SITE.NUM_POSTS_ON_HOMEPAGE);

const projects = (await getCollection("projects"))
  .filter(project => !project.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, SITE.NUM_PROJECTS_ON_HOMEPAGE);

const allwork = (await getCollection("work"))
  .sort((a, b) => new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf())
  .slice(0,SITE.NUM_WORKS_ON_HOMEPAGE);

const work = await Promise.all(
  allwork.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  })
);

const site = Astro.site!;
const siteBase = site.toString();

const abs = (path: string) => new URL(path, site).toString();
const pageUrl = new URL(Astro.url.pathname, site).toString();

const sameAs = (SOCIALS ?? []).map(s => s.HREF).filter(Boolean);
const iso = (d: string | Date) => {
  const dateObj = new Date(typeof d === "string" ? d : d.valueOf());

  const pad = (num: number) => String(num).padStart(2, "0");

  const year = dateObj.getFullYear();
  const month = pad(dateObj.getMonth() + 1);
  const day = pad(dateObj.getDate());
  const hours = pad(dateObj.getHours());
  const minutes = pad(dateObj.getMinutes());

  const tzOffsetMin = -dateObj.getTimezoneOffset();
  const sign = tzOffsetMin >= 0 ? "+" : "-";
  const tzHours = pad(Math.floor(Math.abs(tzOffsetMin) / 60));
  const tzMinutes = pad(Math.abs(tzOffsetMin) % 60);

  return `${year}-${month}-${day}T${hours}:${minutes}:00${sign}${tzHours}:${tzMinutes}`;
};

const latestPosts = blog.map(p => ({
  "@type": "BlogPosting",
  "@id": abs(`blog/${p.slug}/#article`),
  url: abs(`blog/${p.slug}/`),
  headline: p.data.title,
  datePublished: iso(p.data.date),
  inLanguage: "fi",
  author: { "@id": `${siteBase}#person` }
}));

const latestProjects = projects.map(pr => ({
  "@type": "CreativeWork", // set per-project type later if you add a `type` field
  "@id": abs(`projects/${pr.slug}/#item`),
  url: abs(`projects/${pr.slug}/`),
  name: pr.data.title,
  datePublished: iso(pr.data.date),
  inLanguage: "fi"
}));

const homeJsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Person",
      "@id": `${siteBase}#person`,
      "name": SITE.NAME ?? "Niko Karppinen",
      "url": siteBase,
      "description": HOME.DESCRIPTION ?? "Analytiikka, SEO ja datal√§ht√∂inen kehitys.",
      "sameAs": sameAs
    },
    {
      "@type": "WebSite",
      "@id": `${siteBase}#website`,
      "url": siteBase,
      "name": SITE.NAME ?? "Niko Karppinen",
      "publisher": { "@id": `${siteBase}#person` },
      "inLanguage": "fi"
    },
    {
      "@type": "WebPage",
      "@id": `${pageUrl}#webpage`,
      "url": pageUrl,
      "name": HOME.TITLE ?? "Etusivu",
      "isPartOf": { "@id": `${siteBase}#website` },
      "about": { "@id": `${siteBase}#person` },
      "inLanguage": "fi"
    },
    ...(latestPosts.length
      ? [{
          "@type": "ItemList",
          "@id": `${siteBase}#latest-posts`,
          "name": "Viimeisimm√§t artikkelit",
          "itemListElement": latestPosts.map((item, i) => ({
            "@type": "ListItem",
            "position": i + 1,
            "item": item
          }))
        }]
      : []),
    ...(latestProjects.length
      ? [{
          "@type": "ItemList",
          "@id": `${siteBase}#latest-projects`,
          "name": "Viimeisimm√§t projektit",
          "itemListElement": latestProjects.map((item, i) => ({
            "@type": "ListItem",
            "position": i + 1,
            "item": item
          }))
        }]
      : [])
  ]
};
---

<PageLayout title={HOME.TITLE} description={HOME.DESCRIPTION} jsonLd={homeJsonLd}>
  <Container>
    <h4 class="animate font-semibold text-black dark:text-white">
      Hei, min√§ olen Niko Karppinen <span class="text-xl">üëãüèª</span> 
    </h4>
    <div class="space-y-16">
      <section>
        <article class="space-y-4">
          <p class="animate">
            Autan yrityksi√§ muuttamaan datan konkreettiseksi kasvuksi. Ty√∂skentelen analytiikan ja datal√§ht√∂isen kehityksen parissa, ja teht√§v√§ni on varmistaa, ett√§ dataa hy√∂dynnet√§√§n tehokkaasti aina mittaristojen suunnittelusta jatkuvaan kehitykseen.
          </p>
          <p class="animate">
            Ydinosaamistani ovat verkkosivujen analytiikka, hakukoneoptimointi ja ev√§steit√§ kunnioittava mittaaminen. Jaan mielell√§ni osaamistani my√∂s koulutuksissa, webinaareissa ja podcasteissa, erityisesti analytiikan merkityksest√§ liiketoiminnan kehityksess√§.
          </p>
        </article>
      </section>

      <section class="animate space-y-6">
        <div class="flex flex-wrap gap-y-2 items-center justify-between">
          <h5 class="font-semibold text-black dark:text-white">
            Viimeisimm√§t artikkelit
          </h5>
          <Link href="/blog">
            Kaikki artikkelit
          </Link>
        </div>
        <ul class="flex flex-col gap-4">
          {blog.map(post => (
            <li>
              <ArrowCard entry={post} />
            </li>
          ))}
        </ul>
      </section>

      <section class="animate space-y-6">
        <div class="flex flex-wrap gap-y-2 items-center justify-between">
          <h5 class="font-semibold text-black dark:text-white">
            Viimeiset projektit / esiintymiset
          </h5>
          <Link href="/projects">
            Kaikki projektit
          </Link>
        </div>
        <ul class="flex flex-col gap-4">
          {projects.map(project => (
            <li>
              <ArrowCard entry={project} />
            </li>
          ))}
        </ul>
      </section>

      <section class="animate space-y-4">
        <h5 class="font-semibold text-black dark:text-white">
          Verkostoidutaan
        </h5>
        <article>
          <p>
            Verkostoidun mielell√§ni muiden data-, markkinointi- ja teknologiahenkisten kanssa. Jos haluat vaihtaa ajatuksia tai vain sanoa moi, laita viesti√§ sosiaalisessa mediassa tai s√§hk√∂postilla.
          </p>
        </article>
        <ul class="flex flex-wrap gap-2">
          {SOCIALS.map(SOCIAL => (
            <li class="flex gap-x-2 text-nowrap">
              <Link href={SOCIAL.HREF} external aria-label={`${SITE.NAME} on ${SOCIAL.NAME}`}>
                {SOCIAL.NAME}
              </Link>
            </li>
          ))}
        </ul>
      </section>
    </div>
  </Container>
</PageLayout>
